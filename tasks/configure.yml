---
- name: Configure main settings.
  lineinfile:
    dest: "{{ bind_main_config }}"
    regexp: "^#?.+{{ item.option | regex_escape() }}"
    line: "{{ item.option }} {{ item.value }}"
    state: "{{ item.state | default('present') }}"
    mode: 0644
  with_items: "{{ bind_main_config_settings }}"
  notify: restart bind

- name: Configure main options settings.
  lineinfile:
    dest: "{{ bind_option_config }}"
    state: "{{ item.state | default('present') }}"
    mode: 0644
    regexp: "^#?.+{{ item.option | regex_escape() }}"
    insertafter: '^options \{'
    line: |
      {{ item.option }} {{ item.value }}
  with_items: "{{ bind_main_options_settings }}"
  notify: restart bind

- name: Ensure dirs exist.
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ bind_user }}"
    group: "{{ bind_group }}"
    mode: 0755
  with_items:
    - "{{ bind_local_config_path }}"
    - "{{ bind_zones_config_path }}"
  when: bind_zones_entries | length > 0

- name: Configure zones (if entries are configured).
  template:
    src: "named.conf.local.j2"
    dest: "{{ bind_local_config_path }}/{{ bind_local_file }}"
    owner: "{{ bind_user }}"
    group: "{{ bind_group }}"
    mode: 0755
  notify: restart bind
  when: bind_zones_entries | length > 0

- name: list zones files
  debug:
    msg: "{{ bind_zones_entries | map(attribute='file') | list }}"
  when: bind_zones_entries | length > 0

- name: Configure direct zones files (if entries are configured).
  template:
    src: "zone.db.j2"
    dest: "{{ bind_zones_config_path }}/{{ item }}"
    owner: "{{ bind_user }}"
    group: "{{ bind_group }}"
    mode: 0755
  with_items: "{{ bind_zones_entries | selectattr('template', 'equalto', 'db') | map(attribute='file') | list }}"
  notify: restart bind
  when: bind_zones_entries | length > 0

- name: Configure indirect zones files (if entries are configured).
  template:
    src: "zone.rev.j2"
    dest: "{{ bind_zones_config_path }}/{{ item }}"
    owner: "{{ bind_user }}"
    group: "{{ bind_group }}"
    mode: 0755
  with_items: "{{ bind_zones_entries | selectattr('template', 'equalto', 'rev') | map(attribute='file') | list }}"
  notify: restart bind
  when: bind_zones_entries | length > 0
